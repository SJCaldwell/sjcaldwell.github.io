{{/* Custom copy button styling and functionality */}}
<style>
.copy-code {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background: var(--tertiary);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--secondary);
    cursor: pointer;
    transition: all 0.2s ease;
    position: absolute;
    top: 8px;
    right: 8px;
    z-index: 10;
}

.copy-code:hover {
    background: var(--secondary);
    color: var(--theme);
}

.copy-code svg {
    width: 16px;
    height: 16px;
}

/* Ensure no conflicting copy buttons exist */
.copy, .highlight .copy {
    display: none !important;
}

/* Position relative for code blocks */
pre {
    position: relative;
}
</style>

<script>
// Wait for DOM to be fully loaded and ensure no conflicting scripts
document.addEventListener('DOMContentLoaded', function() {
    // Remove any existing copy buttons
    document.querySelectorAll('.copy, [class*="copy"]').forEach(el => {
        if (!el.classList.contains('copy-code')) {
            el.remove();
        }
    });
    
    // Clear any existing copy button event listeners by cloning nodes
    const pres = document.querySelectorAll('pre');
    pres.forEach(pre => {
        const newPre = pre.cloneNode(true);
        pre.parentNode.replaceChild(newPre, pre);
    });
    
    // Add our custom copy buttons to the new clean pre elements
    document.querySelectorAll('pre code').forEach(codeBlock => {
        const pre = codeBlock.parentElement;
        
        // Skip if button already exists
        if (pre.querySelector('.copy-code')) return;
        
        const button = document.createElement('button');
        button.classList.add('copy-code');
        button.setAttribute('aria-label', 'Copy code');
        button.setAttribute('type', 'button');
        
        // Copy icon SVG
        const copyIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>`;
        
        // Checkmark icon SVG
        const checkIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg>`;
        
        button.innerHTML = copyIcon;

        function showSuccess() {
            button.innerHTML = checkIcon;
            button.style.color = '#10b981';
            setTimeout(() => {
                button.innerHTML = copyIcon;
                button.style.color = '';
            }, 2000);
        }

        button.addEventListener('click', function(event) {
            event.preventDefault();
            event.stopPropagation();
            const textToCopy = codeBlock.textContent || codeBlock.innerText;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(textToCopy).then(() => {
                    showSuccess();
                }).catch(() => {
                    fallbackCopy(textToCopy);
                });
            } else {
                fallbackCopy(textToCopy);
            }
        });

        function fallbackCopy(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showSuccess();
            } catch (err) {
                console.error('Copy failed:', err);
            }
            document.body.removeChild(textArea);
        }

        pre.appendChild(button);
    });
});
</script>

{{/* MathJax Configuration */}}
<script>
window.MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']],
    displayMath: [['$$', '$$'], ['\\[', '\\]']],
    processEscapes: true,
    processEnvironments: true
  },
  options: {
    skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
  }
};
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

{{/* Footnote Hover Popups */}}
<style>
.footnote-popup {
    position: absolute;
    background: var(--theme);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 12px 16px;
    max-width: 300px;
    font-size: 0.85em;
    line-height: 1.4;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    font-family: var(--font-mono);
    color: var(--primary);
    display: none;
    pointer-events: auto;
    word-wrap: break-word;
}

.dark .footnote-popup {
    background: #2d2d2d;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.footnote-popup::before {
    content: '';
    position: absolute;
    top: -6px;
    left: 50%;
    transform: translateX(-50%);
    width: 12px;
    height: 12px;
    background: var(--theme);
    border: 1px solid var(--border);
    border-bottom: none;
    border-right: none;
    rotate: 45deg;
}

.dark .footnote-popup::before {
    background: #2d2d2d;
}

/* Style footnote links to be more prominent */
.footnote-ref {
    text-decoration: none !important;
    font-weight: 700;
    padding: 2px 7px;
    border-radius: 4px;
    background: var(--primary);
    color: var(--theme) !important;
    transition: all 0.2s ease;
    position: relative;
    border: 1px solid var(--border);
    font-size: 0.85em;
    line-height: 1;
    display: inline-block;
    min-width: 16px;
    text-align: center;
}

.footnote-ref:hover {
    background: var(--secondary);
    color: var(--theme) !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
}

.dark .footnote-ref {
    background: #ffffff;
    color: #000000 !important;
    border: 1px solid #666666;
}

.dark .footnote-ref:hover {
    background: #e5e5e5;
    color: #000000 !important;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentPopup = null;
    let hideTimeout = null;

    function createFootnotePopup(footnoteId, content) {
        const popup = document.createElement('div');
        popup.className = 'footnote-popup';
        popup.innerHTML = content;
        document.body.appendChild(popup);
        return popup;
    }

    function showPopup(link, popup) {
        if (hideTimeout) {
            clearTimeout(hideTimeout);
            hideTimeout = null;
        }

        const rect = link.getBoundingClientRect();
        const popupRect = popup.getBoundingClientRect();
        
        // Position popup above the footnote link
        let left = rect.left + (rect.width / 2) - (popup.offsetWidth / 2);
        let top = rect.top - popup.offsetHeight - 10;

        // Ensure popup doesn't go off screen
        if (left < 10) left = 10;
        if (left + popup.offsetWidth > window.innerWidth - 10) {
            left = window.innerWidth - popup.offsetWidth - 10;
        }
        if (top < 10) {
            top = rect.bottom + 10; // Show below if no room above
        }

        popup.style.left = left + window.scrollX + 'px';
        popup.style.top = top + window.scrollY + 'px';
        popup.style.display = 'block';
        
        currentPopup = popup;
    }

    function hidePopup() {
        hideTimeout = setTimeout(() => {
            if (currentPopup) {
                currentPopup.style.display = 'none';
                currentPopup = null;
            }
        }, 150);
    }

    // Find all footnote links and add hover functionality
    document.querySelectorAll('a.footnote-ref').forEach(link => {
        const footnoteId = link.getAttribute('href');
        const footnoteElement = document.querySelector(footnoteId);
        
        if (!footnoteElement) return;
        
        // Get footnote content, removing the back reference
        const footnoteContent = footnoteElement.innerHTML
            .replace(/<a[^>]*href="#fnref[^"]*"[^>]*>.*?<\/a>/g, '')
            .trim();
        
        if (!footnoteContent) return;

        const popup = createFootnotePopup(footnoteId, footnoteContent);
        
        link.addEventListener('mouseenter', () => {
            showPopup(link, popup);
        });
        
        link.addEventListener('mouseleave', hidePopup);
        
        // Keep popup visible when hovering over the popup itself
        popup.addEventListener('mouseenter', () => {
            if (hideTimeout) {
                clearTimeout(hideTimeout);
                hideTimeout = null;
            }
        });
        
        popup.addEventListener('mouseleave', hidePopup);
    });

    // Hide popup when scrolling
    window.addEventListener('scroll', () => {
        if (currentPopup) {
            currentPopup.style.display = 'none';
            currentPopup = null;
        }
    });
});
</script>