{{/* Custom copy button styling and functionality */}}
<style>
.copy-code {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background: var(--tertiary);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--secondary);
    cursor: pointer;
    transition: all 0.2s ease;
    position: absolute;
    top: 8px;
    right: 8px;
    z-index: 10;
}

.copy-code:hover {
    background: var(--secondary);
    color: var(--theme);
}

.copy-code svg {
    width: 16px;
    height: 16px;
}

/* Ensure no conflicting copy buttons exist */
.copy, .highlight .copy {
    display: none !important;
}

/* Position relative for code blocks */
pre {
    position: relative;
}
</style>

<script>
// Wait for DOM to be fully loaded and ensure no conflicting scripts
document.addEventListener('DOMContentLoaded', function() {
    // Remove any existing copy buttons
    document.querySelectorAll('.copy, [class*="copy"]').forEach(el => {
        if (!el.classList.contains('copy-code')) {
            el.remove();
        }
    });
    
    // Clear any existing copy button event listeners by cloning nodes
    const pres = document.querySelectorAll('pre');
    pres.forEach(pre => {
        const newPre = pre.cloneNode(true);
        pre.parentNode.replaceChild(newPre, pre);
    });
    
    // Add our custom copy buttons to the new clean pre elements
    document.querySelectorAll('pre code').forEach(codeBlock => {
        const pre = codeBlock.parentElement;
        
        // Skip if button already exists
        if (pre.querySelector('.copy-code')) return;
        
        const button = document.createElement('button');
        button.classList.add('copy-code');
        button.setAttribute('aria-label', 'Copy code');
        button.setAttribute('type', 'button');
        
        // Copy icon SVG
        const copyIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>`;
        
        // Checkmark icon SVG
        const checkIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg>`;
        
        button.innerHTML = copyIcon;

        function showSuccess() {
            button.innerHTML = checkIcon;
            button.style.color = '#10b981';
            setTimeout(() => {
                button.innerHTML = copyIcon;
                button.style.color = '';
            }, 2000);
        }

        button.addEventListener('click', function(event) {
            event.preventDefault();
            event.stopPropagation();
            const textToCopy = codeBlock.textContent || codeBlock.innerText;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(textToCopy).then(() => {
                    showSuccess();
                }).catch(() => {
                    fallbackCopy(textToCopy);
                });
            } else {
                fallbackCopy(textToCopy);
            }
        });

        function fallbackCopy(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showSuccess();
            } catch (err) {
                console.error('Copy failed:', err);
            }
            document.body.removeChild(textArea);
        }

        pre.appendChild(button);
    });
});
</script>

{{/* MathJax Configuration */}}
<script>
window.MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']],
    displayMath: [['$$', '$$'], ['\\[', '\\]']],
    processEscapes: true,
    processEnvironments: true
  },
  options: {
    skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
  }
};
</script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>